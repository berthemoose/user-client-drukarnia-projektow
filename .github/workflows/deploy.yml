name: Docker Build & Deploy (User Client Drukarnia Projekt√≥w CMS)
on:
  push:
    branches:
      - main
      - 'sandbox/*'
  workflow_dispatch:

env: 
  REGISTRY_NAME: ${{ secrets.REGISTRY_LOGIN_SERVER }}
  REPO_NAME: user-client-drukarnia-projektow
  prod_app_name: app-user-client-drukarnia-projektow
  sandbox_app_name: app-sbox-drukarnia-projektow

permissions:
  contents: read

jobs:
  #Build Docker img and push to ACR
  build-and-push:
    runs-on: ubuntu-latest
    steps:      
      - uses: actions/checkout@v3

      - name: Log in to Azure Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.REGISTRY_LOGIN_SERVER }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and Push Docker Image
        run: | 
          docker build . -t $REGISTRY_NAME/$REPO_NAME:${{ github.sha }}
          docker push $REGISTRY_NAME/$REPO_NAME:${{ github.sha }}

  #Deploy to the sandbox app
  deploy-sandbox:
    if: startsWith(github.ref, 'refs/heads/sandbox/')
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: Sandbox
    steps:
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to Sandbox App
      uses: azure/webapps-deploy@v2
      with: 
        app-name: ${{ env.sandbox_app_name }}
        images: ${{ env.REGISTRY_NAME }}/${{ env.REPO_NAME }}:${{ github.sha }}  
      
  #Deploy to staging
  #Only if the branch is 'main'
  deploy-staging:
    if: github.ref == 'refs/heads/main'
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: Staging
    steps:
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    - name: Deploy to Staging Slot
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.prod_app_name }}
        slot-name: staging
        images: ${{ env.REGISTRY_NAME }}/${{ env.REPO_NAME }}:${{ github.sha }}